package com.hungrystudio.adx.sink;


import com.alibaba.fastjson.JSONObject;
import org.apache.flink.streaming.api.functions.sink.filesystem.bucketassigners.BasePathBucketAssigner;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;


public class MyReportBasePathBucketAssigner extends BasePathBucketAssigner<JSONObject> {

    private String target_path;
    private static Map<String, Integer> targetMap = new ConcurrentHashMap<>();

    static {
        targetMap.put("click", 1);
    }

    private static int number = 0;

    public MyReportBasePathBucketAssigner(String target_path) {
        this.target_path = target_path;
    }

    private static final Logger LOG = LoggerFactory.getLogger(MyReportBasePathBucketAssigner.class);

    @Override
    public String getBucketId(JSONObject jsonObject, Context context) {

        /**
         * data_warehouse/qz_ods/ads_model_server_log_inc_hourly_test_click/datepart=%s/hour=%s/
         */
        String HH = jsonObject.getString("hour");
        String yyyyMMdd = jsonObject.getString("dt");
        String group_id = jsonObject.getString("group_id");

        String format = String.format(target_path, yyyyMMdd, HH,group_id);
        System.out.println(format);
        return format;
    }


    public static void main(String[] args) {
        //String str = "{\"data\":{\"action_type\":\"tag_show\",\"address\":{\"country\":\"ID\",\"province\":\"JK\"},\"app_id\":\"video.likeit.lite\",\"app_version\":\"100480\",\"at\":1618813380335,\"commit_id\":\"d732846bf1b347eca5c64c4dfb9e04d1\",\"ct\":1618813380336,\"device\":{\"device_id\":\"m.A4F05E7CF3F9\",\"imei\":\"863114044838212\",\"imsi\":\"510283089960358\",\"mac\":\"A4F05E7CF3F9\",\"net\":\"MOBILE_4G\"},\"ip\":\"115.178.194.247\",\"position\":\"1\",\"rt\":1618813381000,\"st\":1618813380994,\"tags\":[{\"abtest\":\"{\\\"recomd\\\":{\\\"algo_langs\\\":{\\\"dmp\\\":\\\"id\\\",\\\"type\\\":\\\"4\\\"},\\\"af_category\\\":\\\"2\\\",\\\"scene\\\":\\\"minivideo\\\",\\\"bucket_id\\\":\\\"U_1\\\",\\\"af_campaign\\\":\\\"webeye_LIKEit Lite_android_ID_0324_image #2\\\",\\\"user_type\\\":\\\"1\\\",\\\"af_is_first_launch\\\":\\\"false\\\",\\\"label_cnt\\\":\\\"0_0_0_0\\\",\\\"pos\\\":\\\"1\\\",\\\"reco_scene\\\":\\\"minivideo\\\",\\\"af_channel\\\":\\\"ACI_Display\\\",\\\"pre_score\\\":0.7435738444328308,\\\"item_dur\\\":14824,\\\"trace_id\\\":\\\"afb9773e3aae471a9c8b4eaa08819ed9\\\",\\\"is_active\\\":0,\\\"media_source\\\":\\\"googleadwords_int\\\",\\\"is_new\\\":0,\\\"src\\\":\\\"rec\\\",\\\"spider_type\\\":\\\"\\\",\\\"af_agency\\\":\\\"libra\\\",\\\"request_cnt\\\":\\\"1\\\",\\\"user_launch_day\\\":14,\\\"mixer_time\\\":1618813209240,\\\"request_lang\\\":[\\\"id\\\",\\\"indonesian\\\",\\\"in_id\\\",\\\"id\\\",\\\"en\\\"],\\\"hit_exp\\\":[\\\"f_all_recall_results-b\\\",\\\"m_likeit_lite_id_cs6-b2\\\",\\\"m_likeit_lite_id_cs7-t7\\\",\\\"m_likeit_lite_id_cs5-t8\\\"],\\\"trigger_key\\\":[\\\"lite_hot_ID\\\"],\\\"sublibraries\\\":[\\\"t_troy\\\"],\\\"cand\\\":\\\"ugc_lite_hot_ID\\\",\\\"pm\\\":\\\"14\\\"},\\\"dmp\\\":{\\\"src\\\":\\\"{\\\\\\\"dmp_id\\\\\\\":\\\\\\\"0\\\\\\\"}\\\"}}\",\"item_ids\":[\"uZrnk\"],\"position\":\"1\",\"tag_id\":\"h_17cgZ\"}],\"trace_id\":\"3e1d7e3510814fc7b3d7ff9c53a2800e\",\"user\":{\"beyla_id\":\"a.d562c33cd30818cc\",\"user_id\":\"3uIJWk\"}},\"version\":14}";
        //String str = "{\"header\":{\"deviceIdType\":\"mac\",\"timeZone\":25200000,\"country\":\"ID\",\"channel\":\"GOOGLEPLAY\",\"appVerCode\":100480,\"model\":\"Redmi 5A\",\"commitTime\":1618973364822,\"simActiveCnt\":2,\"androidId\":\"ddd08338c2a9a9d7\",\"uniqueId\":\"a.ddd08338c2a9a9d7\",\"deviceId\":\"m.04D13AFB7492\",\"manufacture\":\"Xiaomi\",\"buildNum\":\"3e1b06a67cf5\",\"simCount\":2,\"osVer\":25,\"promotionChannel\":\"\",\"ip\":\"36.85.109.16\",\"osName\":\"android\",\"account\":\"g.3vXLo6\",\"country2\":\"ID\",\"language\":\"in\",\"mac\":\"04D13AFB7492\",\"appId\":\"news.buzzfeed.buzznews\",\"gaid\":\"a9fa9ac1-f802-4c23-a9a1-402f3dd212e3\",\"appVerName\":\"1.0.48\",\"commitId\":\"a65b4598e17b4cd88f1ab15941e86758\",\"mobileType\":0,\"identityId\":\"a99718e6c8943a8e9371edf9fcdc93a8\",\"resolution\":\"720x1280\",\"city\":\"Lhokseumawe\",\"createTime\":1618973364774,\"netType\":2,\"province\":\"AC\",\"appToken\":\"BUZZNEWS\",\"userId\":\"3vXLo6\"},\"content\":{\"app_portal\":\"share_fm_launcher\",\"object_values\":[{\"pve_cur\":\"/news/content_item/0\",\"referrer\":\"{\\\"uc\\\":\\\"m_home\\\",\\\"um\\\":\\\"v4Cy9B\\\",\\\"us\\\":\\\"collection\\\"}\",\"ct\":1618973364759,\"abtest\":\"{\\\"cand\\\":\\\"video_rt\\\",\\\"trigger_key\\\":[\\\"ID\\\"],\\\"sublibraries\\\":[\\\"buzz_mgc\\\",\\\"machine_push\\\",\\\"boutique\\\",\\\"mgc_top_play\\\",\\\"audited\\\"],\\\"bucket_id\\\":\\\"U_10\\\",\\\"trace_id\\\":\\\"405e9f3a1afe4173ad69e2e0e90eed28\\\",\\\"is_new\\\":0,\\\"is_active\\\":1,\\\"hit_exp\\\":[\\\"m_buzznew_id_cs-t3\\\"],\\\"spider_type\\\":\\\"mgc\\\",\\\"item_dur\\\":309127,\\\"algo_langs\\\":{\\\"type\\\":\\\"4\\\",\\\"dmp\\\":\\\"id\\\"},\\\"pm\\\":\\\"14\\\",\\\"src\\\":\\\"rec\\\",\\\"label_cnt\\\":\\\"0_0_0_0\\\",\\\"user_type\\\":\\\"1\\\",\\\"user_launch_day\\\":4,\\\"request_lang\\\":[\\\"id\\\",\\\"indonesian\\\",\\\"in_id\\\",\\\"id\\\",\\\"en\\\"],\\\"reco_scene\\\":\\\"mixed_home\\\",\\\"mixer_time\\\":1618973358918,\\\"af_is_first_launch\\\":\\\"false\\\",\\\"scene\\\":\\\"mixed_home\\\",\\\"request_cnt\\\":\\\"2\\\"}\",\"load_source\":\"NETWORK_PRELOAD\",\"at\":1618973364759,\"item_id\":\"v4Cy9B\",\"item_type\":\"short_video\",\"position\":\"0\"}],\"event_name\":\"show\",\"event_object\":\"item\"},\"metis_timestamp\":\"2021-04-21T02:49:25.131Z\"}\n";
//        String str = "mei\":\"869788044680007\",\"imsi\":\"\",\"isp_name\":\"pt telekomunikasi indonesia\",\"mac\":\"7CD6615A6FE0\",\"net\":\"WIFI\"},\"ip\":\"36.82.98.178\",\"item\":{\"abtest\":\"{\\\"algo_langs\\\":{\\\"dmp\\\":\\\"id\\\",\\\"type\\\":\\\"4\\\"},\\\"scene\\\":\\\"minivideo\\\",\\\"bucket_id\\\":\\\"U_12\\\",\\\"af_campaign\\\":\\\"bella_Lite_and_ID_0319_1.0_金币image\\\",\\\"user_type\\\":\\\"1\\\",\\\"af_is_first_launch\\\":\\\"false\\\",\\\"label_cnt\\\":\\\"0_0_0_0\\\",\\\"pos\\\":\\\"3\\\",\\\"reco_scene\\\":\\\"minivideo\\\",\\\"af_channel\\\":\\\"ACI_Display\\\",\\\"pre_score\\\":0.5737828016281128,\\\"item_dur\\\":17577,\\\"trace_id\\\":\\\"8bdf482164984919a2989ab1b7f4b85c\\\",\\\"is_active\\\":0,\\\"media_source\\\":\\\"googleadwords_int\\\",\\\"is_new\\\":0,\\\"src\\\":\\\"rec\\\",\\\"spider_type\\\":\\\"mgc\\\",\\\"request_cnt\\\":\\\"28\\\",\\\"user_launch_day\\\":15,\\\"mixer_time\\\":1618813239473,\\\"request_lang\\\":[\\\"id\\\",\\\"indonesian\\\",\\\"in_id\\\",\\\"id\\\",\\\"en\\\"],\\\"hit_exp\\\":[\\\"f_all_recall_results-b\\\",\\\"m_likeit_lite_id_cs6-t3\\\",\\\"m_likeit_lite_id_cs7-t7\\\",\\\"m_likeit_lite_id_cs5-t2\\\"],\\\"sublibraries\\\":[\\\"t_troy\\\",\\\"t_boutique_lite\\\"],\\\"cand\\\":\\\"ugc_lite_fm_effective17_ID\\\",\\\"pm\\\":\\\"14\\\"}\",\"abtest_original\":\"{\\\"recomd\\\":{\\\"algo_langs\\\":{\\\"dmp\\\":\\\"id\\\",\\\"type\\\":\\\"4\\\"},\\\"scene\\\":\\\"minivideo\\\",\\\"bucket_id\\\":\\\"U_12\\\",\\\"af_campaign\\\":\\\"bella_Lite_and_ID_0319_1.0_金币image\\\",\\\"user_type\\\":\\\"1\\\",\\\"af_is_first_launch\\\":\\\"false\\\",\\\"label_cnt\\\":\\\"0_0_0_0\\\",\\\"pos\\\":\\\"3\\\",\\\"reco_scene\\\":\\\"minivideo\\\",\\\"af_channel\\\":\\\"ACI_Display\\\",\\\"pre_score\\\":0.5737828016281128,\\\"item_dur\\\":17577,\\\"trace_id\\\":\\\"8bdf482164984919a2989ab1b7f4b85c\\\",\\\"is_active\\\":0,\\\"media_source\\\":\\\"googleadwords_int\\\",\\\"is_new\\\":0,\\\"src\\\":\\\"rec\\\",\\\"spider_type\\\":\\\"mgc\\\",\\\"request_cnt\\\":\\\"28\\\",\\\"user_launch_day\\\":15,\\\"mixer_time\\\":1618813239473,\\\"request_lang\\\":[\\\"id\\\",\\\"indonesian\\\",\\\"in_id\\\",\\\"id\\\",\\\"en\\\"],\\\"hit_exp\\\":[\\\"f_all_recall_results-b\\\",\\\"m_likeit_lite_id_cs6-t3\\\",\\\"m_likeit_lite_id_cs7-t7\\\",\\\"m_likeit_lite_id_cs5-t2\\\"],\\\"sublibraries\\\":[\\\"t_troy\\\",\\\"t_boutique_lite\\\"],\\\"cand\\\":\\\"ugc_lite_fm_effective17_ID\\\",\\\"pm\\\":\\\"14\\\"},\\\"dmp\\\":{\\\"src\\\":\\\"{\\\\\\\"dmp_id\\\\\\\":\\\\\\\"0\\\\\\\"}\\\"}}\",\"duration\":18,\"item_id\":\"up92i\",\"item_type\":\"mini_video\"},\"load_source\":\"NETWORK\",\"module\":4,\"page\":\"{\\\"page_name\\\":\\\"collection\\\",\\\"page_value\\\":\\\"m_home\\\"}\",\"play_duration\":20,\"play_trigger\":\"scroll_down\",\"played_duration\":2,\"portal\":\"share_fm_launcher\",\"position\":\"10\",\"pve_cur\":\"/Popular/Feed\",\"rebuffing_times\":0,\"referrer\":\"{\\\"uc\\\":\\\"collection##m_home\\\",\\\"um\\\":\\\"up92i\\\",\\\"us\\\":\\\"collection\\\",\\\"ut\\\":\\\"click\\\"}\",\"rt\":1618813381001,\"st\":1618813380990,\"trace_id\":\"923779017d6a4baa976143bc5df4e026\",\"url\":\"http://video-l.usicdn.com/sz2/v4/v/210308/up92i/up92i480p.mp4?a=241f0000&v=203d991e0356\",\"user\":{\"beyla_id\":\"a.ee1a20324c052d8e\",\"user_id\":\"3umg3c\"},\"wait_duration\":181},\"version\":14}";

//        String str = "[{\"edit_version\":\"55cc27f14f814e29b639fb99e1f56745\",\"app_name\":\"com.lenovo.anyshare.gps\",\"phy_pos\":\"ad:layer_p_dr_mp3\",\"trace_id\":\"8e712476-aab6-4a50-83dd-a3f1fd688bf1\",\"ad_id\":\"100446\",\"ad_package_name\":\"com.bilibili.app.in\",\"feature_input\":\"{\\\"creatives\\\":{\\\"offline\\\":{},\\\"pass_through\\\":\\\"CP///////////wE=\\\",\\\"ad_info\\\":{\\\"edit_version\\\":\\\"55cc27f14f814e29b639fb99e1f56745\\\",\\\"ad_id\\\":100446,\\\"auto_download\\\":1,\\\"creative_infos\\\":[{\\\"edit_version\\\":0,\\\"creative_id\\\":31864}],\\\"adset\\\":{\\\"campaign\\\":{\\\"ad_app_info\\\":{\\\"package_name\\\":\\\"com.bilibili.app.in\\\"}}},\\\"attr_platform\\\":4}},\\\"context\\\":{\\\"device_info\\\":{\\\"device_model\\\":\\\"VOG-AL00\\\",\\\"connection_type\\\":2,\\\"ip\\\":\\\"118.137.252.217\\\",\\\"os_version\\\":\\\"29\\\",\\\"manufacturer\\\":\\\"HUAWEI\\\"},\\\"pos_info\\\":{\\\"phy_pos\\\":\\\"ad:layer_p_dr_mp3\\\"},\\\"app_info\\\":{\\\"app_name\\\":\\\"com.lenovo.anyshare.gps\\\",\\\"app_ver\\\":4060670},\\\"timestamp\\\":1623331602549},\\\"user_data\\\":{\\\"offline\\\":{},\\\"pass_through\\\":\\\"CP///////////wE=\\\",\\\"online\\\":{\\\"user_id\\\":\\\"a9f47e29cae8482fa4c29c5a1e180b03\\\"}}}\",\"hour\":\"13\",\"user_id\":\"a9f47e29cae8482fa4c29c5a1e180b03\",\"pos_id\":\"676\",\"datepart\":\"20210610\",\"creative_id\":\"31864\"},{\"edit_version\":\"584503bad110b6105797fe302ea396e0\",\"app_name\":\"com.lenovo.anyshare.gps\",\"phy_pos\":\"ad:layer_p_dr_mp3\",\"trace_id\":\"8e712476-aab6-4a50-83dd-a3f1fd688bf1\",\"ad_id\":\"100401\",\"ad_package_name\":\"com.duolingo\",\"feature_input\":\"{\\\"creatives\\\":{\\\"offline\\\":{},\\\"pass_through\\\":\\\"CP///////////wE=\\\",\\\"ad_info\\\":{\\\"edit_version\\\":\\\"584503bad110b6105797fe302ea396e0\\\",\\\"ad_id\\\":100401,\\\"auto_download\\\":1,\\\"creative_infos\\\":[{\\\"edit_version\\\":0,\\\"creative_id\\\":29797}],\\\"adset\\\":{\\\"campaign\\\":{\\\"ad_app_info\\\":{\\\"package_name\\\":\\\"com.duolingo\\\"}}},\\\"attr_platform\\\":1}},\\\"context\\\":{\\\"device_info\\\":{\\\"device_model\\\":\\\"VOG-AL00\\\",\\\"connection_type\\\":2,\\\"ip\\\":\\\"118.137.252.217\\\",\\\"os_version\\\":\\\"29\\\",\\\"manufacturer\\\":\\\"HUAWEI\\\"},\\\"pos_info\\\":{\\\"phy_pos\\\":\\\"ad:layer_p_dr_mp3\\\"},\\\"app_info\\\":{\\\"app_name\\\":\\\"com.lenovo.anyshare.gps\\\",\\\"app_ver\\\":4060670},\\\"timestamp\\\":1623331602549},\\\"user_data\\\":{\\\"offline\\\":{},\\\"pass_through\\\":\\\"CP///////////wE=\\\",\\\"online\\\":{\\\"user_id\\\":\\\"a9f47e29cae8482fa4c29c5a1e180b03\\\"}}}\",\"hour\":\"13\",\"user_id\":\"a9f47e29cae8482fa4c29c5a1e180b03\",\"pos_id\":\"676\",\"datepart\":\"20210610\",\"creative_id\":\"29797\"}]";
        String str = "{\"bundle_id\":\"com.mathbrain.sudoku\",\"ver\":\"1.0\",\"ver_n\":\"1\",\"sdk_ver\":\"1.0.0\",\"os\":\"android\",\"gaid\":\"447d08c2-19b0-4d99-82f5-38287ecab410\",\"model\":\"SM-N950N\",\"vendor\":\"samsung\",\"network\":\"2\",\"ip\":\"103.146.222.24\",\"country\":\"IN\",\"dsp_name\":\"inmobi\",\"ecpm\":\"99\",\"adid\":\"93485ae5-02fe-1000-e71d-0025339eff30\",\"crid\":\"\\u003cadv\\u003e88b37efcd5f34d368e60317c706942a4\\u003ccrid\\u003e7b3f48bc605d446a9c166ad69e7ef47b\",\"adomain\":[\"advertiserDomain.sandbox.inmobi.com\"],\"rid\":\"71713b30-98c4-49d0-b05d-af5501b414ae\",\"pid\":\"34\",\"ptype\":\"1\",\"cst\":\"1733541869\",\"timestamp\":\"1734514288\"}";
        System.out.println(new MyReportBasePathBucketAssigner("s3://hungry-studio-data-warehouse/user/sunlj/adx/data/dt=%s/hour=%s/").getBucketId(JSONObject.parseObject(str), null));
        //s3a://sprs-dw-sg/data_warehouse/qz_test/file_event_video_kafka_report_inc_hourly/datepart=20210421/hour=10/request_app=buzznews/event=show/

    }


}